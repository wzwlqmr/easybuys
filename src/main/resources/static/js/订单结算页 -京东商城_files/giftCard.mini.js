Class("trade.virtual.giftCard",{init:function(e){var t=this;t.options=e;t.virtual=e.virtual;t._init()},_init:function(){var e=this;e._eventDelegate()},_bindInit:function(){var t=this;t._cardKeyInit();t._authCodeInit();$("#giftCardBtn").click(function(){if(t._checkCardKey()&&t._checkAuthCode()){t.virtual.checkPassword("lpkPwdType",function(e){if(e.resp&&e.resp.resultFlag){t.bindGiftCard(0,3)}else{t.virtual._noFundsPassword()}})}});$("#accesskeyBtn").click(function(){if(t._checkCardKey()&&t._checkAuthCode()){t.virtual.checkPassword("lpkPwdType",function(e){if(e.resp&&e.resp.resultFlag){t.bindGiftCard(5,5)}else{t.virtual._noFundsPassword()}})}})},_initECardList:function(e,t,a,r,i,s){var n=this;if(i>0||s==0){if(r===1){$("#gift_card").find("ul li:first").click()}else{$("#consignment_card").find("ul li:first").click()}}else{if(r===1){$("#gift_card").find("ul li:eq(1)").click()}else{$("#consignment_card").find("ul li:eq(1)").click()}}},_switchCardBind:function(e){var t=this;var a=template("e_card_add",{useAuthCode:t.options.useAuthCode,type:e});$("#gift_card").find(".giftcard-add").empty();$("#consignment_card").find(".accesskey-add").empty();if(e===0){$("#gift_card").find(".giftcard-add").html(a);t.flushCheckCode($("#gift_card").find(".form.mt5 input[type=text]"))}else{$("#consignment_card").find(".accesskey-add").html(a);t.flushCheckCode($("#consignment_card").find(".form.mt5 input[type=text]"))}t._bindInit()},_eventDelegate:function(){var a=this;$(".giftcard-enable").delegate(".g-detail.item-selected","click",function(e,t){a.cancelGiftCard(e,1)});$(".accesskey-enable").delegate(".g-detail.item-selected","click",function(e,t){a.cancelGiftCard(e,2)});$(".giftcard-enable").delegate(".g-detail:not(.item-selected)","click",function(t,e){a.virtual.checkPassword("lpkPwdType",function(e){if(e.resp&&e.resp.resultFlag){a.useGiftCard(t,1)}else{a.virtual._noFundsPassword()}})});$(".accesskey-enable").delegate(".g-detail:not(.item-selected)","click",function(t,e){a.virtual.checkPassword("lpkPwdType",function(e){if(e.resp&&e.resp.resultFlag){a.useGiftCard(t,2)}else{a.virtual._noFundsPassword()}})})},_eventUnDelegate:function(){$(".giftcard-enable").undelegate(".g-detail.item-selected","click");$(".accesskey-enable").undelegate(".g-detail.item-selected","click");$(".giftcard-enable").undelegate(".g-detail:not(.item-selected)","click");$(".accesskey-enable").undelegate(".g-detail:not(.item-selected)","click")},_cardKeyInit:function(){var e=this;var t=$(".form.virtual-add-input .itxt");t.keyup(function(){var e=$(this);e.val(e.val().replace(/[^a-zA-Z0-9]/g,"").toUpperCase());e.val(e.val().replace("O","0"));if(e.val().length===4&&e.attr("id")!=="lpkKeyPressFourth"){e.next().next().focus()}});t.mouseover(function(){var e=this;if($(e).parent().find(".tips-msg").is(":hidden")){$(e).parent().find(".tips-msg").show();$(e).parent().find(".error-msg").hide()}})},_authCodeInit:function(){var a=this;$(".form.mt5").delegate("input[type=text]","blur",function(){var e=$(this);if(e.val().length>=1){var t=$("#authCode").next("img").attr("src");a.checkAuthCode({authCode:e.val(),acId:a.getURLParam("acid",t),srcId:a.getURLParam("srcid",t)})}else{a._checkCodeEmpty()}});$(".form.mt5").delegate("img","click",function(){a.flushCheckCode($(this).prevAll("input"))});$(".form.mt5").delegate("div:first","click",function(){a.flushCheckCode($(this).prevAll("input"))})},_checkCodeError:function(){$("#authCode").addClass("error");$("#gift_tips").find("span").removeClass("succ-msg").addClass("tips-msg").text("验证码输入错误或验证码已过期")},_checkCodeEmpty:function(){var e=this;e._checkCodeError();$("#gift_tips").find("span").removeClass("succ-msg").addClass("tips-msg").text("请填写验证码")},_checkCodeDone:function(){$("#authCode").addClass("done");$("#gift_tips").find("span").removeClass("tips-msg").addClass("succ-msg").text("验证码校验成功")},_checkCardKey:function(){var e=this;var t=$("#lpkKeyPressFirst").val()!==""&&$("#lpkKeyPressSecond").val()!==""&&$("#lpkKeyPressThird").val()!==""&&$("#lpkKeyPressFourth").val()!=="";if(!t){$("#lpkKeyPressFirst").parent().find(".tips-msg").hide();$("#lpkKeyPressFirst").parent().find(".error-msg").text("请输入密码");$("#lpkKeyPressFirst").parent().find(".error-msg").show();e.flushCheckCode();$("#authCode").addClass("error")}return t},_checkAuthCode:function(){var e=this;var t=e.options.useAuthCode?$("#authCode").parent().find("span:last").hasClass("succ-msg")&&$("#authCode").val().length>=1:true;if(!t){if($("#authCode").val().length<1){e._checkCodeEmpty()}else{e._checkCodeError()}}return t},_checkLoading:function(e){if(e){$("#authCode").parent().find("div:last").show();$("#gift_tips").hide()}else{$("#authCode").parent().find("div:last").hide();$("#gift_tips").show()}},_checkUseCardStatus:function(e){var t;if(e===1){if(parseInt(window.localStorage.getItem("ECard_gift_total"))>=parseInt(window.localStorage.getItem("ECard_gift_max"))){t=$(".giftcard-scrollbar-origin").find(".warn-tips")}}else{if(parseInt(window.localStorage.getItem("ECard_consignment_total"))>=parseInt(window.localStorage.getItem("ECard_consignment_max"))){t=$(".accesskey-scrollbar-origin").find(".warn-tips")}}if(t){t.show();setTimeout(function(){t.hide()},2e3);return false}return true},_isNeedSubtitle:function(e){return e==42002||e==42012||e==42013||e==42003},flushCheckCode:function(){var e=this;var t=$("#authCode").next("img").attr("src");var a=e.replaceURLParamVal("acid",e.UUID(8,16),t);$("#authCode").next("img").attr("src",a);e._checkLoading(false);$("#authCode").val("");$("#gift_tips").find("span").removeClass("succ-msg").addClass("tips-msg").text("请输入验证码")},checkAuthCode:function(e){var t=this;var a={};a.authCodeParam=e;var r="/virtual/v1/gift-card/auth-code";t._checkLoading(true);var i=function(e){if(e.resp.resultFlag){t._checkCodeDone()}else{t._checkCodeError()}t._checkLoading(false)};$.request({success:i,dataType:"json",contentType:"application/json;charset=UTF-8",method:"POST",param:a,url:r})},queryECard:function(e,a){var r=this;var i;switch(e){case 1:i=$("#gift_card").find(".giftcard-enable");break;case-1:i=$("#gift_card").find(".giftcard-disable");break;case 2:i=$("#consignment_card").find(".accesskey-enable");break;case-2:i=$("#consignment_card").find(".accesskey-disable");break}var s=i.parent();if(localStorage.getItem("ECard_hasMore")!=="true"){s.siblings("p:last").show();return}if(!s.siblings("p:first").is(":hidden")){return}else{s.siblings("p:first").show()}var t={cardListPageSize:r.options.pagesize?r.options.pagesize:200,cardListPageNo:a,queryType:e,flowType:$("#flowType").val()?$("#flowType").val():0};var n=function(e){if(!e.resp.resultFlag){r.virtual.showErrorDlg(getMessage(e.resp));return}else{if(e.resp.giftCardList&&e.resp.giftCardList.length>0){var t=template("e_card_list",e.resp);if(a===1){i.html(t);window.localStorage.setItem("ECard_gift_total",e.resp.orderPrice.giftCardNum);window.localStorage.setItem("ECard_consignment_total",e.resp.orderPrice.consignmentCardNum);window.localStorage.setItem("ECard_gift_max",e.resp.giftCardMaxNum);window.localStorage.setItem("ECard_consignment_max",e.resp.consignmentCardMaxNum)}else{i.append(t)}window.localStorage.setItem("ECard_pageNo",a);window.localStorage.setItem("ECard_hasMore",true)}else{window.localStorage.setItem("ECard_hasMore",false)}}r.virtual._flushOrderPrice(e.resp.orderPrice);if($("couponDownGradeCodeSign")==null){refushVertualused()}if(a===1&&localStorage.getItem("ECard_hasMore")!=="true"){s.siblings("p:last").show()}s.siblings("p:first").hide()};var l="/virtual/v1/gift-card";$.request({success:n,dataType:"json",url:l,contentType:"application/json;charset=UTF-8",data:t,that:r})},bindGiftCard:function(t,a){var r=this;var i=$("#lpkKeyPressFirst").val()+"-"+$("#lpkKeyPressSecond").val()+"-"+$("#lpkKeyPressThird").val()+"-"+$("#lpkKeyPressFourth").val();var e={giftCardKey:i,bindGiftType:t,giftType:a,flowType:$("#flowType").val()?$("#flowType").val():0};if(r.options.useAuthCode){var s={authCode:$("#authCode").val()};e.authCodeParam=s}function n(){$("#lpkKeyPressFirst").val("");$("#lpkKeyPressSecond").val("");$("#lpkKeyPressThird").val("");$("#lpkKeyPressFourth").val("")}var l=function(e){if(!e.resp.resultFlag){r.virtual.showErrorDlg(getMessage(e.resp),r._isNeedSubtitle(e.resp.resultCode)?"刷新一下试试":null);$("#lpkKeyPressFirst").parent().find(".tips-msg").hide();$("#lpkKeyPressFirst").parent().find(".error-msg").text(getMessage(e.resp));$("#lpkKeyPressFirst").parent().find(".error-msg").show();r.flushCheckCode()}else{r.useMaterialGiftCard(i,t,a);$(".addsucc-tips").show();r.flushCheckCode();setTimeout(function(){$(".addsucc-tips").hide()},2e3);isNeedPaymentPassword();n()}};var o="/virtual/v1/gift-card";$.request({success:l,dataType:"json",method:"POST",contentType:"application/json;charset=UTF-8",param:e,url:o})},useMaterialGiftCard:function(e,t,a){var r=this;var i={bindGiftType:t,giftCardType:a,flowType:$("#flowType").val()?$("#flowType").val():0};if(!r._checkUseCardStatus(a===3?1:2)){return}var s="/virtual/v1/gift-card/"+e;var n=function(e){if(!e.resp.resultFlag){if(a===3){r.virtual.showErrorDlg("绑定礼品卡成功，不符合使用规则，未使用");$("#gift_card").find("ul li:eq(1)").click()}else{r.virtual.showErrorDlg("绑定领货码成功，不符合使用规则，未使用");$("#consignment_card").find("ul li:eq(1)").click()}}else{if(a===3){$("#gift_card").find("ul li:first").click()}else{$("#consignment_card").find("ul li:first").click()}if(a===3){window.localStorage.setItem("ECard_gift_total",parseInt(window.localStorage.getItem("ECard_gift_total"))+1)}else{window.localStorage.setItem("ECard_consignment_total",parseInt(window.localStorage.getItem("ECard_consignment_total"))+1)}}save_Pay(0);isNeedPaymentPassword()};$.request({url:s,method:"PUT",dataType:"json",contentType:"application/json;charset=UTF-8",param:i,success:n})},useGiftCard:function(a,r){var i=this;if($(a.currentTarget).hasClass("item-selected")){return}if(!i._checkUseCardStatus(r)){return}i._eventUnDelegate();var e={cardListPageSize:i.options.pagesize?i.options.pagesize:200,cardListPageNo:$(a.currentTarget).data("page-no"),queryType:r,flowType:$("#flowType").val()?$("#flowType").val():0};var t=function(e){if(!e.resp.resultFlag){i.virtual.showErrorDlg(getMessage(e.resp),i._isNeedSubtitle(e.resp.resultCode)?"刷新一下试试":null);return}if(e.resp.giftCardList&&e.resp.giftCardList.length>0){if(e.resp.giftCardList[0].selected){var t=template("e_card_item",e.resp.giftCardList[0]);$(a.currentTarget).parents("li").html(t);if(r===1){window.localStorage.setItem("ECard_gift_total",parseInt(window.localStorage.getItem("ECard_gift_total"))+1)}else{window.localStorage.setItem("ECard_consignment_total",parseInt(window.localStorage.getItem("ECard_consignment_total"))+1)}}}else{save_Pay(0)}isNeedPaymentPassword();i.virtual._flushOrderPrice(e.resp.orderPrice)};$.request({url:"/virtual/v1/gift-card/"+$(a.currentTarget).data("gift-key"),method:"POST",contentType:"application/json;charset=UTF-8",success:t,param:e,always:function(){i._eventUnDelegate();i._eventDelegate()}})},cancelGiftCard:function(a,r){var i=this;if(!$(a.currentTarget).hasClass("item-selected")){return}i._eventUnDelegate();var e={cardListPageSize:i.options.pagesize?i.options.pagesize:200,cardListPageNo:$(a.currentTarget).data("page-no"),queryType:r,flowType:$("#flowType").val()?$("#flowType").val():0};var t=function(e){if(!e.resp.resultFlag){i.virtual.showErrorDlg(getMessage(e.resp),i._isNeedSubtitle(e.resp.resultCode)?"刷新一下试试":null);return}if(e.resp.giftCardList&&e.resp.giftCardList.length>0){if(!e.resp.giftCardList[0].selected){var t=template("e_card_item",e.resp.giftCardList[0]);$(a.currentTarget).parents("li").html(t);if(r===1){window.localStorage.setItem("ECard_gift_total",parseInt(window.localStorage.getItem("ECard_gift_total"))-1)}else{window.localStorage.setItem("ECard_consignment_total",parseInt(window.localStorage.getItem("ECard_consignment_total"))-1)}}}else{save_Pay(0)}isNeedPaymentPassword();i.virtual._flushOrderPrice(e.resp.orderPrice)};$.request({url:"/virtual/v1/gift-card/"+$(a.currentTarget).data("gift-id"),method:"DELETE",contentType:"application/json;charset=UTF-8",success:t,param:e,always:function(){i._eventUnDelegate();i._eventDelegate()}})},_scrollEventBind:function(a){var r=this;if(a===1||a===-1){$(".giftcard-scrollbar-origin").unbind();$(".giftcard-scrollbar-origin").scroll(function(e,t){r._scrollLoading(this,a)})}else{$(".accesskey-scrollbar-origin").unbind();$(".accesskey-scrollbar-origin").scroll(function(e,t){r._scrollLoading(this,a)})}},_scrollLoading:function(e,t,a){var r=this;var i=$(e)[0].scrollTop;var s=$(e)[0].scrollHeight-$(e).height();if(i/s>=.95&&!a){r.queryECard(t,parseInt(window.localStorage.getItem("ECard_pageNo"))+1)}},addFlowTypeParam:function(e){var t=$("#flowType").val();if(isEmpty(t)){return e}else{if(isEmpty(e)){return"flowType="+t}else{return e+"&flowType="+t}}},parseParam:function(a,r){var i=this;var s="";if(a instanceof String||a instanceof Number||a instanceof Boolean){s+="&"+r+"="+encodeURIComponent(a)}else{$.each(a,function(e){var t=r==null?e:r+(a instanceof Array?"["+e+"]":"."+e);s+="&"+i.parseParam(this,t)})}return s.substr(1)},getURLParam:function(e,t){var a=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i");if(typeof t!=="undefined"){var r=t.substr(1).match(a)}else{var r=window.location.search.substr(1).match(a)}if(r!=null)return unescape(r[2]);return null},replaceURLParamVal:function(paramName,replaceWith,url){if(typeof url!=="undefined"){var oUrl=url}else{var oUrl=window.location.href.toString()}var re=eval("/("+paramName+"=)([^&]*)/gi");return oUrl.replace(re,paramName+"="+replaceWith)},UUID:function(e,t){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");var r=[],i;t=t||a.length;if(e){for(i=0;i<e;i++)r[i]=a[0|Math.random()*t]}else{var s;r[8]=r[13]=r[18]=r[23]="-";r[14]="4";for(i=0;i<36;i++){if(!r[i]){s=0|Math.random()*16;r[i]=a[i==19?s&3|8:s]}}}return r.join("")}});